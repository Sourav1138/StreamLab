<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StreamLab | Cinema</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/controls.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        glass: "rgba(255, 255, 255, 0.03)",
                        glassBorder: "rgba(255, 255, 255, 0.08)",
                        primary: "#f43f5e",
                        dark: "#050505"
                    },
                    fontFamily: {
                        sans: ['Manrope', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        :root { --primary: #f43f5e; --bg-deep: #050505; --surface: #121212; }
        body { 
            background-color: #050505; 
            color: #e5e5e5;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(244, 63, 94, 0.08), transparent 25%), 
                radial-gradient(circle at 85% 30%, rgba(59, 130, 246, 0.08), transparent 25%);
        }
        
        .noise-overlay {
            position: fixed; inset: 0; pointer-events: none; z-index: 0;
            opacity: 0.05;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* Modern Glass Card */
        .cyber-card {
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8), inset 0 0 0 1px rgba(255,255,255,0.03);
        }

        /* --- PLAYER CSS --- */
        .player-card {
            max-width: 1280px; width: 100%; margin: 0 auto; border-radius: 16px; overflow: hidden;
            background: #000; box-shadow: 0 0 0 1px rgba(255,255,255,0.05), 0 30px 80px -10px rgba(0,0,0,0.9);
            position: relative; display: flex; flex-direction: column;
        }
        .video-wrapper { position: relative; width: 100%; aspect-ratio: 16 / 9; background: #000; flex-shrink: 0; }
        .player-card:fullscreen { border-radius: 0; width: 100%; height: 100%; justify-content: center; }
        .player-card:fullscreen .video-wrapper { aspect-ratio: unset; height: 100%; }
        .shaka-overflow-menu-button, .shaka-current-time, .shaka-seek-bar-container, .shaka-bottom-controls, .shaka-spinner-container { display: none !important; }

        .controls-layer {
            position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.5) 20%, rgba(0,0,0,0) 50%);
            opacity: 0; transition: opacity 0.25s ease; display: flex; flex-direction: column; justify-content: flex-end; z-index: 20; pointer-events: none;
        }
        .video-wrapper:hover .controls-layer, .controls-layer.active { opacity: 1; pointer-events: auto; }

        .scrubber-container { width: 100%; height: 20px; display: flex; align-items: center; cursor: pointer; position: relative; z-index: 30; }
        .scrubber-track { width: 100%; height: 3px; background: rgba(255,255,255,0.2); border-radius: 2px; position: relative; transition: height 0.1s; }
        .scrubber-container:hover .scrubber-track { height: 5px; }
        .scrubber-buffer { position: absolute; top:0; left:0; height:100%; background: rgba(255,255,255,0.3); border-radius: 2px; width:0; }
        .scrubber-fill { position: absolute; top:0; left:0; height:100%; background: var(--primary); border-radius: 2px; width:0; max-width: 100%; }
        .scrubber-knob { position: absolute; top: 50%; right: -6px; transform: translateY(-50%) scale(0); width: 14px; height: 14px; background: #fff; border-radius: 50%; box-shadow: 0 0 15px rgba(0,0,0,0.6); transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .scrubber-container:hover .scrubber-knob { transform: translateY(-50%) scale(1); }

        .buffering-layer { position: absolute; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); display: flex; align-items: center; justify-content: center; z-index: 10; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .buffering-layer.visible { opacity: 1; pointer-events: auto; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-left-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }

        .settings-menu { display: none; flex-direction: column; z-index: 40; background: rgba(20,20,20,0.95); backdrop-filter: blur(12px); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .settings-menu.open { display: flex; }
        @media (min-width: 768px) { .settings-menu { position: absolute; bottom: 90px; right: 40px; width: 260px; border-radius: 12px; padding: 6px; border: 1px solid rgba(255,255,255,0.1); transform-origin: bottom right; animation: popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1); } }
        @media (max-width: 767px) { .settings-menu { position: relative; width: 100%; bottom: auto; right: auto; border-radius: 0; padding: 10px; background: #0a0a0a; border-top: 1px solid rgba(255,255,255,0.1); animation: slideDown 0.2s ease-out; } .player-card:fullscreen .settings-menu { position: absolute; bottom: 80px; right: 20px; width: 220px; border-radius: 12px; padding: 6px; background: rgba(20,20,20,0.95); } }
        .menu-item { padding: 10px 14px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; font-size: 13px; font-weight: 500; color: #eee; border-radius: 8px; transition: background 0.1s; }
        .menu-item:hover { background: rgba(255,255,255,0.1); }
        .stats-panel { position: absolute; top: 16px; left: 16px; background: rgba(0,0,0,0.85); padding: 12px; border-radius: 12px; font-family: 'JetBrains Mono', monospace; font-size: 10px; color: #4ade80; z-index: 25; display: none; pointer-events: none; width: 200px; border: 1px solid rgba(74, 222, 128, 0.2); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        @media (min-width: 768px) { .stats-panel { top: 20px; left: 20px; padding: 16px; width: 240px; font-size: 12px; } }
        .stats-panel.visible { display: block; }

        /* --- ADVANCED PROCESSING ANIMATION --- */
        .scanner-container {
            position: relative; width: 80px; height: 80px;
            display: flex; align-items: center; justify-content: center;
        }
        .scanner-ring {
            position: absolute; inset: 0; border-radius: 50%;
            border: 2px solid rgba(244, 63, 94, 0.1);
        }
        .scanner-ring::after {
            content: ''; position: absolute; inset: -2px; border-radius: 50%;
            border: 2px solid transparent; border-top-color: #f43f5e;
            animation: spin 2s linear infinite;
        }
        .scanner-core {
            width: 40px; height: 40px; background: rgba(244, 63, 94, 0.1);
            border-radius: 50%; border: 1px solid rgba(244, 63, 94, 0.3);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 20px rgba(244, 63, 94, 0.2);
            animation: pulse 2s ease-in-out infinite;
        }
        .scanner-core i { font-size: 18px; color: #f43f5e; }
        
        /* --- DRIVE ONLY INPUT --- */
        .input-group {
            background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
        }
        .input-group:focus-within {
            border-color: #f43f5e; box-shadow: 0 0 0 1px rgba(244, 63, 94, 0.2);
        }
        .error-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; border-color: #ef4444 !important; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { transform: scale(0.95); opacity: 0.8; } 50% { transform: scale(1.05); opacity: 1; } }
        @keyframes scan { 0% { top: 0; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.98) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

    </style>
</head>
<body class="antialiased">
    <div class="noise-overlay"></div>

    <!-- MAIN APP CONTAINER -->
    <div class="relative z-10 w-full min-h-screen flex items-center justify-center p-4">
        
        <!-- UPLOAD / INPUT SCREEN -->
        <div id="upload-screen" class="w-full max-w-[480px] cyber-card rounded-2xl p-8 animate-[popIn_0.6s_cubic-bezier(0.22,1,0.36,1)]">
            
            <!-- VIEW: FORM -->
            <div id="upload-content" class="transition-all duration-300">
                <!-- Header -->
                <div class="flex flex-col items-center mb-10">
                    <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-rose-500/20 to-rose-600/5 border border-rose-500/20 flex items-center justify-center mb-4 shadow-[0_0_30px_-5px_rgba(244,63,94,0.3)]">
                        <i class="ph-fill ph-aperture text-2xl text-rose-500"></i>
                    </div>
                    <h1 class="text-3xl font-bold tracking-tight text-white mb-1">StreamLab</h1>
                    <p class="text-xs font-mono text-white/40 uppercase tracking-widest">Cinema Engine v2.0</p>
                </div>

                <!-- Tabs -->
                <div class="flex p-1 bg-white/5 rounded-xl mb-8 border border-white/5">
                    <button onclick="switchTab('file')" id="tab-file" class="flex-1 py-2.5 text-xs font-semibold rounded-lg transition-all text-white bg-white/10 shadow-lg">FILE</button>
                    <button onclick="switchTab('link')" id="tab-link" class="flex-1 py-2.5 text-xs font-semibold rounded-lg transition-all text-white/40 hover:text-white">LINK</button>
                </div>

                <!-- File Upload -->
                <div id="view-file" class="block">
                    <label class="block group cursor-pointer mb-6">
                        <input type="file" id="fileInput" class="hidden" accept=".mkv,.mp4,.mov,.avi">
                        <div class="h-32 border border-dashed border-white/10 rounded-xl flex flex-col items-center justify-center bg-white/[0.02] group-hover:bg-white/[0.05] group-hover:border-rose-500/40 transition-all duration-300">
                            <i class="ph ph-upload-simple text-3xl text-white/20 mb-3 group-hover:text-rose-400 group-hover:scale-110 transition-all"></i>
                            <span id="fileName" class="text-white/40 text-xs font-medium px-8 text-center truncate w-full">Click to browse video files</span>
                        </div>
                    </label>
                    <button onclick="processAction('file')" id="btn-file" class="w-full h-12 bg-gradient-to-r from-rose-600 to-rose-700 hover:from-rose-500 hover:to-rose-600 text-white font-bold rounded-xl shadow-lg shadow-rose-900/20 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                        <span>Initialize Stream</span>
                        <i class="ph-bold ph-arrow-right"></i>
                    </button>
                </div>

                <!-- Link Input (Drive Only) -->
                <div id="view-link" class="hidden">
                    <div class="mb-6">
                        <div id="url-container" class="input-group rounded-xl flex items-center px-4 h-12 mb-2">
                            <i class="ph-fill ph-google-drive-logo text-white/30 mr-3 text-lg"></i>
                            <input type="text" id="urlInput" placeholder="Paste Google Drive Link Only" class="bg-transparent border-none outline-none text-sm text-white placeholder-white/20 w-full font-medium">
                        </div>
                        <p id="link-error" class="text-[10px] text-rose-500 font-medium hidden pl-1"><i class="ph-bold ph-warning"></i> Only Google Drive links allowed</p>
                    </div>
                    <button onclick="processAction('link')" id="btn-link" class="w-full h-12 bg-gradient-to-r from-rose-600 to-rose-700 hover:from-rose-500 hover:to-rose-600 text-white font-bold rounded-xl shadow-lg shadow-rose-900/20 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                        <span>Access Drive</span>
                        <i class="ph-bold ph-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- VIEW: PROCESSING (NEXT LEVEL ANIMATION) -->
            <div id="processing-view" class="hidden flex-col items-center justify-center py-8">
                <div class="scanner-container mb-8">
                    <div class="scanner-ring"></div>
                    <div class="scanner-core">
                        <i class="ph-fill ph-film-strip"></i>
                    </div>
                    <!-- Fake scanning lines in background -->
                    <div class="absolute inset-x-[-20px] top-1/2 h-[1px] bg-rose-500/20"></div>
                    <div class="absolute inset-y-[-20px] left-1/2 w-[1px] bg-rose-500/20"></div>
                </div>
                
                <h2 class="text-lg font-bold text-white mb-2">Analyzing Stream</h2>
                <div class="flex flex-col items-center gap-1">
                    <p class="text-xs text-rose-400 font-mono animate-pulse">ESTABLISHING UPLINK...</p>
                    <p class="text-[10px] text-white/30 font-mono">Transcoding H.264 / AAC [DASH]</p>
                </div>
                
                <!-- Progress Bar Mockup -->
                <div class="w-48 h-1 bg-white/10 rounded-full mt-6 overflow-hidden">
                    <div class="h-full bg-rose-500 w-1/3 animate-[scan_1.5s_ease-in-out_infinite] rounded-full"></div>
                </div>
            </div>

        </div>

        <!-- PLAYER SCREEN -->
        <div id="player-screen" class="hidden w-full flex-col items-center justify-center animate-[popIn_0.3s_ease-out]">
            <div class="w-full max-w-[1280px] flex items-center justify-between mb-4 md:mb-6 px-1 md:px-2">
                <button onclick="resetApp()" class="group flex items-center gap-2 md:gap-3 text-white/60 hover:text-white transition-colors">
                    <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white/5 flex items-center justify-center group-hover:bg-white/10 border border-white/5 transition-all">
                        <i class="ph-bold ph-arrow-left text-base md:text-lg"></i>
                    </div>
                    <span class="text-sm md:text-base font-semibold">Library</span>
                </button>
                <h2 id="video-title" class="text-sm md:text-base font-medium text-white/80 truncate max-w-[150px] md:max-w-lg"></h2>
                <div class="w-8 md:w-10"></div>
            </div>
            <div class="player-card group" id="video-container">
                <div class="video-wrapper">
                    <video id="video" class="w-full h-full object-contain" autoplay></video>
                    
                    <div id="stats-panel" class="stats-panel">
                        <div class="flex justify-between mb-2 pb-2 border-b border-white/10"><span class="text-white font-bold">NERD STATS</span></div>
                        <div class="flex justify-between mb-1"><span>Res:</span><span id="stat-res" class="text-white">--</span></div>
                        <div class="flex justify-between mb-1"><span>Bitrate:</span><span id="stat-bitrate" class="text-white">--</span></div>
                        <div class="flex justify-between mb-1"><span>Dropped:</span><span id="stat-dropped" class="text-rose-400">0</span></div>
                        <div class="flex justify-between"><span>Buffer:</span><span id="stat-buffer" class="text-blue-400">0s</span></div>
                    </div>
                    
                    <div id="buffering-layer" class="buffering-layer"><div class="spinner"></div></div>
                    
                    <div class="controls-layer p-3 md:p-8" id="controls-layer">
                        <div class="scrubber-container mb-2 md:mb-6 group/scrub" id="seek-area">
                            <div class="scrubber-track">
                                <div id="buffered-bar" class="scrubber-buffer"></div>
                                <div id="current-bar" class="scrubber-fill"><div class="scrubber-knob"></div></div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3 md:gap-6">
                                <button id="play-btn" class="text-white hover:text-rose-500 transition transform active:scale-95 flex items-center"><i class="ph-fill ph-play text-2xl md:text-4xl"></i></button>
                                <div class="flex items-center gap-2 md:gap-3 group/vol">
                                    <button id="mute-btn" class="text-white/80 hover:text-white transition flex items-center"><i class="ph-fill ph-speaker-high text-lg md:text-2xl"></i></button>
                                    <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="1" class="hidden md:block w-0 overflow-hidden group-hover/vol:w-24 transition-all duration-300 bg-transparent h-1 cursor-pointer accent-white">
                                </div>
                                <div class="text-[10px] md:text-sm font-mono font-medium text-white/70 tracking-wide mt-0.5"><span id="current-time">00:00</span> <span class="text-white/30 mx-0.5 md:mx-1">/</span> <span id="total-time">00:00</span></div>
                            </div>
                            <div class="flex items-center gap-3 md:gap-5">
                                <button id="settings-btn" class="text-white/80 hover:text-white hover:rotate-90 transition duration-300 flex items-center"><i class="ph-fill ph-gear text-xl md:text-3xl"></i></button>
                                <button id="fullscreen-btn" class="text-white/80 hover:text-white hover:scale-110 transition flex items-center"><i class="ph-bold ph-corners-out text-xl md:text-3xl"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="settings-menu" class="settings-menu">
                    <div id="settings-main">
                        <div class="menu-item" onclick="showSubmenu('audio')">
                            <div class="flex items-center"><i class="ph-fill ph-speaker-high"></i> <span>Audio Track</span></div>
                            <div class="flex items-center gap-1 text-white/50 text-[10px] md:text-xs"><span id="current-audio-label">Default</span> <i class="ph-bold ph-caret-right" style="margin:0; font-size:10px;"></i></div>
                        </div>
                        <div class="menu-item" onclick="toggleStats()">
                            <div class="flex items-center"><i class="ph-fill ph-chart-bar"></i> <span>Stats for Nerds</span></div>
                            <span id="stats-status" class="text-white/50 text-[10px] md:text-xs">Off</span>
                        </div>
                    </div>
                    <div id="settings-audio" style="display:none;">
                        <div class="menu-item border-b border-white/10 mb-1" onclick="showSubmenu('main')"><div class="flex items-center text-white/60"><i class="ph-bold ph-arrow-left"></i> <span>Back</span></div></div>
                        <div id="audio-tracks-container" class="max-h-40 overflow-y-auto custom-scroll"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- LOGIC ---
        let player, TOTAL_DURATION_SEC = 0, CURRENT_OFFSET = 0, PREFERRED_LANG = null, POLL_INTERVAL, STATS_INTERVAL;
        const video = document.getElementById('video');

        // Tabs
        function switchTab(t) {
            document.querySelectorAll('#upload-screen button[id^="tab-"]').forEach(b => {
                b.classList.remove('bg-white/10', 'text-white', 'shadow-lg');
                b.classList.add('text-white/40');
            });
            const active = document.getElementById('tab-'+t);
            active.classList.add('bg-white/10', 'text-white', 'shadow-lg');
            active.classList.remove('text-white/40');
            
            document.getElementById('view-file').style.display = t==='file'?'block':'none';
            document.getElementById('view-link').style.display = t==='link'?'block':'none';
        }

        // Action
        const fileInput = document.getElementById('fileInput');
        fileInput.onchange = () => { if(fileInput.files[0]) document.getElementById('fileName').innerText = fileInput.files[0].name; };

        async function processAction(type) {
            const formData = new FormData();
            
            if(type === 'file') {
                if(!fileInput.files[0]) return;
                formData.append('file', fileInput.files[0]);
                formData.append('type', 'file');
            } else {
                const url = document.getElementById('urlInput').value.trim();
                const container = document.getElementById('url-container');
                const err = document.getElementById('link-error');
                
                // CLIENT SIDE VALIDATION
                if (!url.includes('drive.google.com')) {
                    container.classList.add('error-shake');
                    err.classList.remove('hidden');
                    setTimeout(() => container.classList.remove('error-shake'), 500);
                    return;
                } else {
                    err.classList.add('hidden');
                }

                formData.append('url', url);
                formData.append('type', 'url');
            }

            // UI Transition
            document.getElementById('upload-content').classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                document.getElementById('upload-content').style.display = 'none';
                document.getElementById('processing-view').classList.remove('hidden');
                document.getElementById('processing-view').classList.add('flex');
            }, 300);

            try {
                if (player) { await player.destroy(); player = null; }
                const res = await fetch('/process', { method: 'POST', body: formData });
                const data = await res.json();
                
                if (data.status === 'started') {
                    TOTAL_DURATION_SEC = data.duration_sec;
                    CURRENT_OFFSET = 0;
                    document.getElementById('video-title').innerText = data.filename;
                    document.getElementById('total-time').innerText = formatTime(TOTAL_DURATION_SEC);
                    
                    document.getElementById('upload-screen').classList.add('hidden');
                    document.getElementById('player-screen').classList.remove('hidden');
                    document.getElementById('player-screen').classList.add('flex');
                    document.getElementById('buffering-layer').classList.add('visible');
                    
                    startPolling();
                } else {
                    alert(data.message || "Error processing");
                    location.reload();
                }
            } catch (e) { alert("Failed"); location.reload(); }
        }

        function startPolling() { POLL_INTERVAL = setInterval(async () => { try { const res = await fetch('/status'); const data = await res.json(); if (data.ready) { clearInterval(POLL_INTERVAL); initPlayer(); } } catch(e) {} }, 1000); }

        async function initPlayer() {
            shaka.polyfill.installAll(); player = new shaka.Player(video);
            player.configure({ streaming: { bufferingGoal: 30, rebufferingGoal: 2, alwaysStreamText: true, jumpLargeGaps: true } });
            
            const bufLayer = document.getElementById('buffering-layer');

            player.addEventListener('buffering', (e) => { 
                if(e.buffering) bufLayer.classList.add('visible'); 
                else bufLayer.classList.remove('visible');
            });
            
            player.addEventListener('variantchanged', updateAudioMenu);
            
            try { 
                await player.load('/manifest.mpd?t=' + Date.now()); 
                if(PREFERRED_LANG) { 
                    const tracks = player.getVariantTracks(); 
                    const match = tracks.find(t => t.language === PREFERRED_LANG); 
                    if(match) player.selectVariantTrack(match, true); 
                } 
                updateAudioMenu(); 
            } catch(e) { console.error(e); }
        }

        // Controls Logic
        const playBtn = document.getElementById('play-btn');
        function updatePlayBtn() { 
            const isMobile = window.innerWidth < 768;
            const iconSize = isMobile ? 'text-2xl' : 'text-4xl';
            playBtn.innerHTML = video.paused 
                ? `<i class="ph-fill ph-play ${iconSize}"></i>` 
                : `<i class="ph-fill ph-pause ${iconSize}"></i>`;
        }
        video.addEventListener('play', updatePlayBtn); video.addEventListener('pause', updatePlayBtn);
        playBtn.onclick = () => video.paused ? video.play() : video.pause();

        // Seek
        const seekArea = document.getElementById('seek-area');
        
        video.addEventListener('timeupdate', () => {
            if(TOTAL_DURATION_SEC > 0) {
                const realTime = video.currentTime + CURRENT_OFFSET;
                const pct = (realTime / TOTAL_DURATION_SEC) * 100;
                document.getElementById('current-bar').style.width = pct + "%";
                document.getElementById('current-time').innerText = formatTime(realTime);
            }
        });

        seekArea.onclick = (e) => {
            if(TOTAL_DURATION_SEC > 0) {
                const rect = seekArea.getBoundingClientRect();
                const pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                const target = pct * TOTAL_DURATION_SEC;
                const range = player.seekRange();
                
                if(target - CURRENT_OFFSET >= range.start && target - CURRENT_OFFSET <= range.end) {
                    video.currentTime = target - CURRENT_OFFSET;
                } else {
                    document.getElementById('buffering-layer').classList.add('visible');
                    fetch('/seek', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ timestamp: target }) })
                    .then(r=>r.json()).then(d => {
                        if(d.status === 'seeking') {
                            CURRENT_OFFSET = target;
                            player.unload().then(() => startPolling());
                        }
                    });
                }
            }
        };

        // Menus
        const settingsMenu = document.getElementById('settings-menu');
        document.getElementById('settings-btn').onclick = (e) => { e.stopPropagation(); settingsMenu.classList.toggle('open'); showSubmenu('main'); };
        document.addEventListener('click', (e) => { if (!settingsMenu.contains(e.target) && e.target.id !== 'settings-btn') settingsMenu.classList.remove('open'); });
        function showSubmenu(id) { document.getElementById('settings-main').style.display = id==='main'?'block':'none'; document.getElementById('settings-audio').style.display = id==='audio'?'block':'none'; }

        function updateAudioMenu() {
            if(!player) return; const tracks = player.getVariantTracks(); const container = document.getElementById('audio-tracks-container'); container.innerHTML = '';
            const seen = new Set(); const unique = []; tracks.forEach(t => { const l = t.language === 'und' ? 'Original' : t.language; if(!seen.has(l)) { seen.add(l); unique.push(t); } });
            const langNames = new Intl.DisplayNames(['en'], { type: 'language' });
            unique.forEach(t => {
                const isActive = t.active; let display = "Original"; if(t.language !== 'und') { try { display = langNames.of(t.language); } catch(e){ display = t.language.toUpperCase(); } }
                if(isActive) document.getElementById('current-audio-label').innerText = display;
                const div = document.createElement('div'); div.className = "menu-item";
                div.innerHTML = `<div class="flex items-center gap-2">${isActive ? '<i class="ph-fill ph-check text-rose-500"></i>' : '<div class="w-4"></div>'}<span class="${isActive ? 'text-white' : 'text-gray-400'}">${display}</span></div>`;
                div.onclick = () => { if(!isActive) { PREFERRED_LANG = t.language; player.selectVariantTrack(t, true); const wasPlaying = !video.paused; setTimeout(() => { if(wasPlaying && video.paused) video.play(); }, 500); settingsMenu.classList.remove('open'); } };
                container.appendChild(div);
            });
        }
        
        // Utils
        function resetApp() { location.reload(); }
        function formatTime(s) { const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sc = Math.floor(s%60); return h>0 ? `${h}:${p(m)}:${p(sc)}` : `${m}:${p(sc)}`; }
        function p(n){ return n.toString().padStart(2,'0'); }
        document.getElementById('volume-slider').oninput = (e) => video.volume = e.target.value; document.getElementById('mute-btn').onclick = () => video.muted = !video.muted;
        document.getElementById('fullscreen-btn').onclick = () => { if(!document.fullscreenElement) document.getElementById('video-container').requestFullscreen(); else document.exitFullscreen(); };
        
        // Stats
        function toggleStats() { 
            const p = document.getElementById('stats-panel'); p.classList.toggle('visible'); 
            const on = p.classList.contains('visible');
            document.getElementById('stats-status').innerText = on ? "On" : "Off";
            if(on) STATS_INTERVAL = setInterval(() => {
                if(!player) return; const stats = player.getStats(); const t = player.getVariantTracks().find(x=>x.active);
                if(t) { document.getElementById('stat-res').innerText = `${t.width}x${t.height}`; document.getElementById('stat-bitrate').innerText = `${Math.round(t.bandwidth/1024)} kbps`; }
                document.getElementById('stat-dropped').innerText = stats.droppedFrames; document.getElementById('stat-buffer').innerText = stats.bufferingTime.toFixed(1)+'s';
            }, 1000); else clearInterval(STATS_INTERVAL);
        }
    </script>
</body>
</html>
